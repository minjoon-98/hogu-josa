<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <title>호구조사</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
        }

        .container {
            width: 100%;
            overflow-x: auto;
            /* 가로 스크롤 추가 */
            white-space: nowrap;
            text-align: center;
        }

        .card {
            display: inline-block;
            width: 300px;
            height: 400px;
            margin-right: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .custom-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: auto;
            margin-bottom: auto;
            text-align: center;
        }

        .custom-subtitle {
            font-size: 1rem;
            margin-top: auto;
            margin-bottom: auto;
            text-align: center;
        }

        .block {
            clear: both;
            margin-bottom: auto;
            padding-bottom: auto;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // 사용자 정보를 가져오는 요청을 보냄
            let token = localStorage.getItem('access_token');
            if (token) {
                $.ajax({
                    url: "/users",
                    method: "GET",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    success: function (users) {
                        addCardInfo(users);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching users:", error);
                    }
                });
            } else {
                console.error("No access token found.");
            }
        });

        function signOut() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = "/";
        }

        function addCardInfo(users) {
            for (let user of users) {
                let { name, location, birthday, motivation, interests, mbti, major, baekjoon_rank, relationship_status, pet_status, hobbies, filepath } = user;

                let cardContentHtml = `
                <div class="card" onclick="showCardInfo('${filepath}', '${name}', '${location}', '${birthday}', '${motivation}', '${interests}', '${mbti}', '${major}', '${baekjoon_rank}', '${relationship_status}', '${pet_status}', '${hobbies}')">
                    <div class="card-image">
                        <figure class="image is-1by1">
                            <img src="${filepath}" alt="User Image" style="display:block; margin:0 auto; height: 280px; width:auto;">
                        </figure>
                    </div>
                    <div class="media">
                        <div class="media-content">
                            <p class="title is-5">${name}</p>
                        </div>
                    </div>
                    <div class="content">
                        <p class="subtitle is-6">${motivation}</p>
                    </div>
                </div>
            `;
                $('#card-list').append(cardContentHtml);
            }
        }

        function showCardInfo(filepath, name, location, birthday, motivation, interests, mbti, major, baekjoon_rank, relationship_status, pet_status, hobbies) {
            var showModal = document.querySelector('.modal');
            showModal.querySelector('.modal-card-title').textContent = name + '의 상세 정보';

            var accessToken = localStorage.getItem('access_token');
            $.ajax({
                url: "/find",
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + accessToken
                },
                success: function (currUser) {
                    let visable_name = name;
                    let visable_location = currUser['location'] || '잠김';
                    let visable_birthday = currUser['birthday'] || '잠김';
                    let visable_motivation = motivation;
                    let visable_interests = currUser['interests'] || '잠김';
                    let visable_mbti = currUser['mbti'] || '잠김';
                    let visable_major = currUser['major'] || '잠김';
                    let visable_baekjoon_rank = currUser['baekjoon_rank'] || '잠김';
                    let visable_relationship_status = relationship_status;
                    let visable_pet_status = pet_status;
                    let visable_hobbies = currUser['hobbies'] || '잠김';

                    $('#cardDetails').html(`
                    <img src="${filepath}" alt="User Image" style="display:block; margin:0 auto; height: 200px; width:auto;">
                    <div class="block">
                        <p class="custom-title">이름</p>
                        <p class="custom-subtitle">${visable_name}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">사는 지역</p>
                        <p class="custom-subtitle">${visable_location}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">생일</p>
                        <p class="custom-subtitle">${visable_birthday}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">지원 동기</p>
                        <p class="custom-subtitle">${visable_motivation}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">관심 분야</p>
                        <p class="custom-subtitle">${visable_interests}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">MBTI</p>
                        <p class="custom-subtitle">${visable_mbti}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">전공</p>
                        <p class="custom-subtitle">${visable_major}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">백준 랭킹</p>
                        <p class="custom-subtitle">${visable_baekjoon_rank}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">애인 유무</p>
                        <p class="custom-subtitle">${visable_relationship_status}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">반려동물 유무</p>
                        <p class="custom-subtitle">${visable_pet_status}</p>
                    </div>
                    <div class="block">
                        <p class="custom-title">취미</p>
                        <p class="custom-subtitle">${visable_hobbies}</p>
                    </div>
                `);
                    showModal.classList.add('is-active');
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching user details:", error);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            var modals = Array.from(document.querySelectorAll('.modal'));
            var modalButtons = Array.from(document.querySelectorAll('.modal .delete, .modal-background'));
            modalButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    modals.forEach(function (modal) {
                        modal.classList.remove('is-active');
                    });
                });
            });
        });

        function scrollHorizontally(e) {
            e.preventDefault();
            var container = document.getElementById("card-list");
            var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
            container.scrollLeft -= (delta * 40); // 40은 스크롤 속도 조절

            if (container.scrollLeft === (container.scrollWidth - container.clientWidth)) {
                window.scrollBy(0, 100); // 오른쪽 끝에 도달 시 아래로 이동
            }

            if (container.scrollLeft === 0) {
                window.scrollBy(0, -100); // 왼쪽 끝에 도달 시 위로 이동
            }
        }
    </script>
</head>

<body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://jungle.krafton.com/">
                <img src="https://jungle.krafton.com/resource/images/common/logo.svg" alt="Krfton Jungle Logo"
                    width="112" height="28">
            </a>
        </div>
    </nav>
    <h1 class="title is-1">호구조사</h1>
    <div class="columns is-mobile">
        <div class="column is-4 is-offset-8">
            <a href="/mypage"><button class="button is-success is-inverted">내 정보 수정</button></a>
            <button class="button is-danger is-inverted" onclick="signOut()">로그아웃</button>
        </div>
    </div>
    <div class="container" id="card-list" onwheel="scrollHorizontally(event)">
    </div>
    <!-- 모달 -->
    <div class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title"></p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <div id="cardDetails">
                </div>
            </section>
            <footer class="modal-card-foot">
            </footer>
        </div>
    </div>
</body>

</html>