<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<title>호구조사</title>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
    }
    h1 {
        text-align: center;
        margin-top: 20px;
    }
    .container {
        width: 80%;
        margin: 50px auto;
        overflow-x: auto;
        white-space: nowrap;
        text-align: center;
    }
    .card {
        display: inline-block;
        width: 300px;
        height: 400px;
        margin-right: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer; /* 추가: 커서를 포인터로 변경하여 클릭 가능하다는 것을 나타냄 */
    }
    .card:hover {
        transform: translateY(-5px);
    }
</style>
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        // 이 부분에서 로그인 여부를 확인하고, 필요한 경우 토큰을 업데이트하도록 수정할 수 있습니다.
        var access_token = localStorage.getItem('access_token');
        if (!access_token) {
            // 로그인이 필요한 경우, 로그인 페이지로 리다이렉트하거나 다른 작업을 수행할 수 있습니다.
            window.location.href = "/"; // 로그인 페이지로 리다이렉트
        } else {
            // 액세스 토큰을 헤더에 추가
            $.ajaxSetup({
                headers: {
                    'Authorization': 'Bearer ' + access_token
                }
            });
    
            // 사용자 정보 가져오기
            $.get("/users", function(users) {
                addCardInfo(users);
            }).fail(function(xhr) {
                if (xhr.status == 401) {
                    // 토큰 만료 등의 이유로 인증되지 않은 경우, 리프레시 토큰을 사용하여 토큰을 갱신할 수 있습니다.
                    refreshAccessToken();
                } else {
                    // 다른 오류 처리
                    $('#card-list').html('<p>오류가 발생했습니다. 다시 시도해주세요.</p>');
                }
            });
        }
    });
    
    function refreshAccessToken() {
        var refresh_token = localStorage.getItem('refresh_token');
    
        $.ajax({
            type: "POST",
            url: "http://localhost:5001/refresh",
            contentType: "application/json",
            headers: {
                'Authorization': 'Bearer ' + refresh_token
            },
            success: function (response) {
                localStorage.setItem('access_token', response.access_token); // 새로운 access_token을 로컬 스토리지에 저장
                console.log("Access token refreshed successfully");
                // 새로운 access_token을 받아온 후 다시 사용자 정보를 가져오는 등의 동작 수행
                $.get("/users", function(users) {
                    addCardInfo(users);
                }).fail(function(xhr) {
                    // 오류 처리
                });
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
                // 에러 처리
            }
        });
    }
</script>
    
<script>
$(document).ready(function() {
    $.get("/users", function(users) {
        addCardInfo(users);
    }).fail(function(xhr) {
        if (xhr.status == 401) {
            // Unauthorized error
            $('#card-list').html('<p>인증되지 않았습니다. 로그인 후 다시 시도해주세요.</p>');
        } else {
            // Other errors
            $('#card-list').html('<p>오류가 발생했습니다. 다시 시도해주세요.</p>');
        }
    });
});

function addCardInfo(users) {
    for (let i = 0; i < users.length; i++) {
        let user = users[i];
        let name = user.name;
        let motivation = user.motivation;
        let cardContentHtml = `
            <div class="card" onclick="showCardInfo('${name}')">
                <div class="card-content">
                    <div class="media">
                        <div class="media-content">
                            <p class="title is-5">${name}</p>
                        </div>
                    </div>
                    <div class="content">
                        <p class="subtitle is-6">${motivation}</p>
                    </div>
                </div>
            </div>
        `;
        $('#card-list').append(cardContentHtml);
    }
}

function showCardInfo(cardName) {
    var showModal = document.querySelector('.modal');
    var cardDetails = document.getElementById('cardDetails');
    cardDetails.innerHTML = '<p>' + cardName + '의 상세 정보를 여기에 표시합니다.</p>';
    showModal.classList.add('is-active');
}

function closeModal() {
    var closeModal = document.querySelector(".modal");
    closeModal.classList.remove('is-active');
}

var hideModal = document.querySelector('.modal');
hideModal.addEventListener("click", e => {
    if (e.target.classList.contains("modal-background")) {
        closeModal();
    }
});
</script>
<body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://jungle.krafton.com/">
                <img src="https://jungle.krafton.com/resource/images/common/logo.svg" alt="Krfton Jungle Logo" width="112" height="28">
            </a>
        </div>
    </nav>
    <h1 class="title is-1">호구조사</h1>
    <div class="columns is-mobile">
        <div class="column is-4 is-offset-8">
            <a href="/mypage"><button class="button is-success is-inverted">내 정보 수정</button></a>
        </div>
    </div>
    <div class="container" id="card-list">
    </div>
</body>
</html>
